<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableau de bord ‚Äî AllergoZymeProtect</title>
  <style>
    :root { --gold:#c9a227; --gold-strong:#b68f1e; --white:#ffffff; --ink:#2b2b2b; --muted:rgba(43,43,43,.65); --line:rgba(182,143,30,.16); }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;background:var(--white);color:var(--ink);overflow-x:hidden}

    /* HEADER */
    header{position:sticky;top:0;background:rgba(255,255,255,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(8px);z-index:100}
    .bar{max-width:1100px;margin:auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;animation:float 4s ease-in-out infinite;filter:drop-shadow(0 0 8px rgba(201,162,39,.25))}
    .brand h1{font-size:1.2rem;color:var(--gold-strong);letter-spacing:1.3px;margin:0}
    nav{display:flex;gap:10px;align-items:center}
    .nav-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--gold-strong);font-weight:600;cursor:pointer;text-decoration:none;transition:.25s;box-shadow:0 6px 14px rgba(182,143,30,.08)}
    .nav-btn:hover{transform:translateY(-2px)}
    .logout{background:linear-gradient(90deg,var(--gold),var(--gold-strong));color:#fff;border:none}

    .status{max-width:1100px;margin:8px auto;display:flex;align-items:center;justify-content:space-between;padding:0 18px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);font-weight:700;color:var(--gold-strong);box-shadow:0 4px 14px rgba(182,143,30,.1)}
    .dot{width:9px;height:9px;border-radius:50%}.ok .dot{background:#1bc98e}.bad .dot{background:#ff6b6b}

    .btn{display:inline-block;padding:12px 18px;border-radius:12px;font-weight:700;border:none;cursor:pointer;transition:.25s}
    .btn.gold{background:linear-gradient(90deg,var(--gold),var(--gold-strong));color:#fff;box-shadow:0 10px 30px rgba(182,143,30,.2)}
    .btn.ghost{background:#fff;color:var(--gold-strong);border:1px solid var(--line)}
    .btn:hover{transform:translateY(-2px)}

    main{max-width:1100px;margin:20px auto 80px;padding:0 18px}
    h2{color:var(--gold-strong);font-size:1.6rem;margin-top:0}

    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:22px;margin-top:20px;box-shadow:0 12px 40px rgba(182,143,30,.08)}
    .muted{color:var(--muted)}
    .qr-center{display:flex;flex-direction:column;align-items:center;gap:20px}
    .qr-item{border:1px solid var(--line);border-radius:14px;padding:14px;width:240px;text-align:center;background:#fff;box-shadow:0 10px 28px rgba(182,143,30,.06)}
    .qr-item img{border-radius:10px}
    .qr-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    .table-tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px}
    .input{padding:12px 14px;border-radius:12px;border:1px solid var(--line);min-width:240px;outline:none}
    .tables-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;margin-top:10px}
    .state{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-weight:700;background:#fff}
    .yes .dot{background:#1bc98e}.no .dot{background:#ff6b6b}

    .map-box{position:fixed;bottom:12px;right:12px;width:300px;height:220px;border:2px solid var(--line);border-radius:12px;overflow:hidden;box-shadow:0 6px 22px rgba(0,0,0,.08)}

    /* PAYWALL */
    .paywall{position:fixed;inset:0;background:rgba(255,255,255,.9);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:200}
    .pay-modal{width:min(560px,92vw);border:1px solid var(--line);border-radius:18px;background:#fff;padding:24px;text-align:center;box-shadow:0 20px 60px rgba(182,143,30,.18)}
    .pay-modal h3{color:var(--gold-strong);margin:0 0 8px}.pay-modal p{color:var(--muted)}.pay-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}

    footer{text-align:center;padding:16px;color:var(--muted);border-top:1px solid var(--line)}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <img src="assets/logo.png" alt="AllergoZymeProtect" />
        <h1>AllergoZymeProtect</h1>
      </div>
      <nav>
        <a href="dashboard.html" class="nav-btn">Tableau de bord</a>
        <a href="archivepage.html" class="nav-btn">Archives</a>
        <a href="formation.html" class="nav-btn">Formation</a>
        <button id="logoutBtn" class="nav-btn logout">D√©connexion</button>
      </nav>
    </div>
  </header>

  <div class="status">
    <div id="subPill" class="pill ok"><span class="dot"></span><span id="subText">Abonnement actif</span></div>
    <button id="refreshBtn" class="btn ghost">‚ü≥ Rafra√Æchir</button>
  </div>

  <main>
    <!-- QR G√âN√âRAL (toujours identique) -->
    <section class="card qr-center">
      <h2>QR G√©n√©ral</h2>
      <p class="muted">Ce QR ne change jamais : il pointe toujours vers votre page de scan principale.</p>
      <button id="showGeneralBtn" class="btn gold">üì± Afficher le QR G√©n√©ral</button>
      <div id="generalQR" class="qr-center"></div>
    </section>

    <!-- TABLES QR (un QR unique par table) -->
    <section id="tables" class="card qr-center">
      <h2>Tables QR</h2>
      <p class="muted">Chaque table poss√®de un QR unique. T√©l√©chargez ou imprimez pour poser sur la table.</p>
      <div class="table-tools">
        <input id="tableInput" class="input" type="text" placeholder="Nom ou n¬∞ de table (ex : 5, A1, Terrasse)" />
        <button id="addTableBtn" class="btn gold">‚ûï Ajouter la table</button>
      </div>
      <div id="tableGrid" class="tables-grid"></div>
    </section>
  </main>

  <!-- Mini carte -->
  <div class="map-box">
    <iframe id="mapFrame" src="" width="100%" height="100%" style="border:0" loading="lazy"></iframe>
  </div>

  <!-- PAYWALL -->
  <div id="paywall" class="paywall" aria-hidden="true">
    <div class="pay-modal">
      <h3>Abonnement inactif</h3>
      <p>Votre abonnement est inactif ou expir√©. Veuillez le renouveler pour continuer √† utiliser AllergoZymeProtect.</p>
      <div class="pay-actions">
        <button id="payNow" class="btn gold">üí≥ Payer l‚Äôabonnement</button>
        <button class="btn ghost" onclick="window.open('mailto:contact@allergozyme.com')">Contacter le support</button>
      </div>
    </div>
  </div>

  <footer>&copy; 2025 AllergoZymeProtect ‚Äî Transparence & S√©curit√©</footer>

  <script type="module">
    import { supabase } from './assets/supabase.js';
    const BASE_DOMAIN = 'https://allergozymeprotect.fr';
    const PAYPAL_LINK = 'https://www.paypal.com/webapps/hermes?token=5YS528552S022562S&useraction=commit#/checkout/login';

    // Refs
    const paywall = document.getElementById('paywall');
    const payNow = document.getElementById('payNow');
    const subPill = document.getElementById('subPill');
    const subText = document.getElementById('subText');

    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    const showGeneralBtn = document.getElementById('showGeneralBtn');
    const generalQR = document.getElementById('generalQR');

    const tableInput = document.getElementById('tableInput');
    const addTableBtn = document.getElementById('addTableBtn');
    const tableGrid = document.getElementById('tableGrid');

    const mapFrame = document.getElementById('mapFrame');

    // State
    let user=null, restaurant=null, tables=[];

    const todayBounds=()=>{const d=new Date();const Y=d.getFullYear(),M=String(d.getMonth()+1).padStart(2,'0'),D=String(d.getDate()).padStart(2,'0');return [`${Y}-${M}-${D}T00:00:00Z`,`${Y}-${M}-${D}T23:59:59Z`];}
    const escapeHtml=s=>String(s||'').replace(/[&<>"'`=\/]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[ch]));

    async function init(){
      const auth = await supabase.auth.getUser();
      if(!auth.data.user){ window.location.href='login.html'; return; }
      user = auth.data.user;

      const { data: resto, error } = await supabase.from('restaurants').select('*').eq('contact_email', user.email).single();
      if(error || !resto){ alert('Restaurant introuvable'); return; }
      restaurant = resto;

      // Abonnement
      const active = !!restaurant.has_paid && (!restaurant.paid_until || new Date(restaurant.paid_until) >= new Date());
      setPayStatus(active);

      // Carte
      if (restaurant.latitude && restaurant.longitude) {
        mapFrame.src = `https://www.allergozymelabel.com/map?lat=${restaurant.latitude}&lng=${restaurant.longitude}&zoom=15`;
      } else {
        mapFrame.src = `https://www.allergozymelabel.com/map`;
      }

      // Tables
      await loadTables();
    }

    function setPayStatus(active){
      if(active){ subPill.classList.remove('bad'); subPill.classList.add('ok'); subText.textContent='Abonnement actif'; paywall.style.display='none'; }
      else { subPill.classList.remove('ok'); subPill.classList.add('bad'); subText.textContent='Abonnement inactif'; paywall.style.display='flex'; }
    }

    // QR GENERAL ‚Äî TOUJOURS LE M√äME
    showGeneralBtn.addEventListener('click', ()=>{
      const url = `${BASE_DOMAIN}/scan/${restaurant.id}`; // <-- identique √† chaque fois
      const img = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
      generalQR.innerHTML = `
        <div class="qr-item">
          <div style="font-weight:800;color:var(--gold-strong)">QR G√©n√©ral</div>
          <img src="${img}" width="200" height="200" alt="QR G√©n√©ral" />
          <div class="qr-actions">
            <a class="nav-btn" href="${img}" download="${restaurant.name}_QR_general.png">T√©l√©charger</a>
            <button class="nav-btn" onclick="window.open('${img}','_blank')">Imprimer</button>
          </div>
        </div>`;
    });

    // TABLES
    async function loadTables(){
      const { data } = await supabase.from('tables').select('*').eq('restaurant_id', restaurant.id).order('table_number',{ascending:true});
      tables=data||[];
      await renderTables();
    }

    async function renderTables(){
      tableGrid.innerHTML='';
      if(!tables.length){ tableGrid.innerHTML=`<div class="muted">Aucune table ‚Äî ajoutez-en une ci-dessus.</div>`; return; }

      const [from,to]=todayBounds();
      for(const t of tables){
        const { count } = await supabase.from('clients_signatures').select('*',{count:'exact',head:true})
          .eq('restaurant_id',restaurant.id).eq('table_id',t.id)
          .gte('created_at',from).lte('created_at',to);
        const hasVal = count>0;

        const url = `${BASE_DOMAIN}/scan/${restaurant.id}?table=${t.id}`;  // <-- unique √† la table
        const img = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;

        const card=document.createElement('div');
        card.className='qr-item';
        card.innerHTML=`
          <div style="font-weight:700">Table ${escapeHtml(t.table_number)}</div>
          <img src="${img}" width="180" height="180" alt="QR Table ${escapeHtml(t.table_number)}" />
          <div class="state ${hasVal?'yes':'no'}"><span class="dot"></span><span>Validations aujourd‚Äôhui : ${hasVal?'Oui':'Non'}</span></div>
          <div class="qr-actions">
            <a class="nav-btn" href="${img}" download="Table_${escapeHtml(t.table_number)}_QR.png">T√©l√©charger</a>
            <button class="nav-btn" onclick="window.open('${img}','_blank')">Imprimer</button>
          </div>
        `;
        tableGrid.appendChild(card);
      }
    }

    // Ajouter table
    addTableBtn.addEventListener('click', async ()=>{
      const val = tableInput.value.trim(); if(!val){ tableInput.focus(); return; }
      const { error } = await supabase.from('tables').insert([{ restaurant_id: restaurant.id, table_number: val }]);
      if(error){ alert('Erreur ajout table : '+error.message); return; }
      tableInput.value=''; await loadTables();
    });

    // Actions globales
    refreshBtn.addEventListener('click', async ()=>{ await loadTables(); });
    payNow.addEventListener('click', ()=>{ window.location.href='payment.html'; });
    logoutBtn.addEventListener('click', async ()=>{ await supabase.auth.signOut(); window.location.href='login.html'; });

    init();
  </script>
</body>
</html>
