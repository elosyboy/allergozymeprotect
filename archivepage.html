<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Archives ‚Äî AllergoZymeProtect</title>
  <style>
    :root {
      --gold: #c9a227;
      --gold-strong: #b68f1e;
      --white: #ffffff;
      --ink: #2b2b2b;
      --muted: rgba(43,43,43,.65);
      --line: rgba(182,143,30,.16);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background:var(--white);
      color:var(--ink);
      overflow-x:hidden;
    }

    header{
      position:sticky;top:0;
      background:rgba(255,255,255,.9);
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(8px);
      z-index:100;
    }
    .bar{max-width:1100px;margin:auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;animation:float 4s ease-in-out infinite;filter:drop-shadow(0 0 8px rgba(201,162,39,.25))}
    .brand h1{font-size:1.2rem;color:var(--gold-strong);letter-spacing:1.3px;margin:0}
    nav{display:flex;gap:10px;align-items:center}
    .nav-btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--gold-strong);
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      transition:.25s;
      box-shadow:0 6px 14px rgba(182,143,30,.08);
    }
    .nav-btn:hover{transform:translateY(-2px)}
    .logout{background:linear-gradient(90deg,var(--gold),var(--gold-strong));color:#fff;border:none}

    main{max-width:1100px;margin:40px auto 80px;padding:0 18px;text-align:center}
    h2{color:var(--gold-strong);font-size:1.6rem;margin-top:0;text-shadow:0 0 12px rgba(182,143,30,.1)}

    .filters{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:20px 0}
    select, input{
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:0.95rem;
      outline:none;
      background:#fff;
      color:var(--ink);
    }
    .btn{
      display:inline-block;
      padding:12px 18px;
      border-radius:12px;
      font-weight:700;
      border:none;
      cursor:pointer;
      transition:.25s;
    }
    .btn.gold{
      background:linear-gradient(90deg,var(--gold),var(--gold-strong));
      color:#fff;
      box-shadow:0 10px 30px rgba(182,143,30,.2);
    }
    .btn.ghost{
      background:#fff;
      color:var(--gold-strong);
      border:1px solid var(--line);
    }
    .btn:hover{transform:translateY(-2px)}

    .records{
      margin-top:30px;
      display:grid;
      gap:14px;
    }
    .record{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 18px;
      background:#fff;
      box-shadow:0 8px 20px rgba(182,143,30,.05);
    }
    .info{
      text-align:left;
      line-height:1.4;
      color:var(--ink);
    }
    .info span{display:block;font-size:0.9em;color:var(--muted)}
    footer{text-align:center;padding:16px;color:var(--muted);border-top:1px solid var(--line)}

    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <img src="assets/logo.png" alt="AllergoZymeProtect" />
        <h1>AllergoZymeProtect</h1>
      </div>
      <nav>
        <a href="dashboard.html" class="nav-btn">Tableau de bord</a>
        <a href="formation.html" class="nav-btn">Formation</a>
        <button id="logoutBtn" class="nav-btn logout">D√©connexion</button>
      </nav>
    </div>
  </header>

  <main>
    <h2>Archives des signatures</h2>
    <p class="muted">Consultez et exportez les signatures clients enregistr√©es dans votre √©tablissement.</p>

    <div class="filters">
      <select id="monthSelect">
        <option value="">Mois</option>
      </select>
      <select id="daySelect">
        <option value="">Jour</option>
      </select>
      <input id="searchInput" type="text" placeholder="Nom, pr√©nom ou table..." />
      <button id="searchBtn" class="btn gold">üîç Rechercher</button>
    </div>

    <div id="records" class="records">
      <p class="muted">Aucune donn√©e pour le moment.</p>
    </div>
  </main>

  <footer>&copy; 2025 AllergoZymeProtect ‚Äî S√©curit√© & Transparence</footer>

  <script type="module">
    import { supabase } from './assets/supabase.js';

    const monthSelect = document.getElementById('monthSelect');
    const daySelect = document.getElementById('daySelect');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const records = document.getElementById('records');
    const logoutBtn = document.getElementById('logoutBtn');

    let user=null, restaurant=null;

    async function init() {
      const auth = await supabase.auth.getUser();
      if(!auth.data.user){ window.location.href='login.html'; return; }
      user = auth.data.user;

      const { data: resto, error } = await supabase
        .from('restaurants')
        .select('*')
        .eq('contact_email', user.email)
        .single();
      if(error || !resto){ alert('Restaurant introuvable'); return; }
      restaurant = resto;

      populateMonths();
    }

    function populateMonths() {
      const now = new Date();
      for(let m=0;m<12;m++){
        const date = new Date(now.getFullYear(), m);
        const opt = document.createElement('option');
        opt.value = m+1;
        opt.textContent = date.toLocaleString('fr-FR',{month:'long'});
        monthSelect.appendChild(opt);
      }
      monthSelect.value = now.getMonth()+1;
    }

    async function search() {
      const month = parseInt(monthSelect.value);
      const day = parseInt(daySelect.value);
      const term = searchInput.value.trim().toLowerCase();

      const start = new Date(new Date().getFullYear(), month-1, day||1, 0,0,0);
      const end = new Date(new Date().getFullYear(), month-1, day||31, 23,59,59);

      const { data, error } = await supabase
        .from('clients_signatures')
        .select('*')
        .eq('restaurant_id', restaurant.id)
        .gte('created_at', start.toISOString())
        .lte('created_at', end.toISOString())
        .order('created_at', { ascending: false });

      if(error){ console.error(error); return; }

      const filtered = data.filter(item=>{
        if(!term) return true;
        return (
          item.client_name?.toLowerCase().includes(term) ||
          item.client_surname?.toLowerCase().includes(term) ||
          item.table_number?.toLowerCase().includes(term)
        );
      });

      renderRecords(filtered);
    }

    function renderRecords(list){
      records.innerHTML='';
      if(!list.length){
        records.innerHTML='<p class="muted">Aucune signature trouv√©e pour ces crit√®res.</p>';
        return;
      }

      for(const rec of list){
        const div = document.createElement('div');
        div.className='record';
        div.innerHTML=`
          <div class="info">
            <strong>${rec.client_name || '‚Äî'} ${rec.client_surname || ''}</strong>
            <span>Table : ${rec.table_number || '‚Äî'}</span>
            <span>Date : ${new Date(rec.created_at).toLocaleString('fr-FR')}</span>
          </div>
          <button class="btn ghost" onclick="window.open('mailto:contact@allergozyme.com?subject=Demande justificatif ${rec.id}&body=Restaurant: ${restaurant.name}%0D%0AClient: ${rec.client_name} ${rec.client_surname}%0D%0ADate: ${rec.created_at}%0D%0ATable: ${rec.table_number}')">üìÑ Demander un justificatif</button>
        `;
        records.appendChild(div);
      }
    }

    logoutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      window.location.href='login.html';
    });

    searchBtn.addEventListener('click', search);
    monthSelect.addEventListener('change', async ()=>{
      const month = parseInt(monthSelect.value);
      daySelect.innerHTML='<option value="">Jour</option>';
      const daysInMonth = new Date(new Date().getFullYear(), month, 0).getDate();
      for(let d=1; d<=daysInMonth; d++){
        const opt=document.createElement('option');
        opt.value=d;
        opt.textContent=d;
        daySelect.appendChild(opt);
      }
    });

    init();
  </script>
</body>
</html>
